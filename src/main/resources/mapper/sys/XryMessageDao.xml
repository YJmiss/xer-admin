<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.oservice.admin.modules.sys.dao.XryMessageDao">

    <!--查询返回的数据总数-->
    <select id="countTotal" parameterType="java.util.Map" resultType="java.lang.Long">
        select count(*) from xry_message a left join xry_course b on a.obj_id=b.id
        left join xry_teacher c on a.user_id=c.id where 1=1
        <if test="params.type != null and params.type != ''">
            and a.msg_type like #{params.type}
        </if>
        <if test="params.objId != null and params.objId != ''">
            and a.obj_id like #{params.objId}
        </if>
        <if test="params.userId != null and params.userId != ''">
            and a.user_id like #{params.userId}
        </if>
    </select>
    <!--自定义分页查询-->
    <select id="pageList" parameterType="java.util.Map" resultType="java.util.Map">
        select a.*,b.title as courseTitle, b.id as courseId, c.real_name as realName,c.id as teacherId
        from xry_message a
        left join xry_course b on a.obj_id=b.id
        left join xry_teacher c on a.user_id=c.id where 1=1
        <if test="params.type != null and params.type != ''">
            and a.msg_type like #{params.type}
        </if>
        <if test="params.objId != null and params.objId != ''">
            and a.obj_id like #{params.objId}
        </if>
        <if test="params.userId != null and params.userId != ''">
            and a.user_id like #{params.userId}
        </if>
        <if test="params.pageSize != null and params.pageSize != ''">
            limit ${params.pageNo},${params.pageSize}
        </if>
    </select>
    <!--发布消息、取消发布-->
    <update id="updateMessageStatus" parameterType="java.util.Map">
        update xry_message set status = #{flag}, publish_date = #{publishDate} where id in
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>
    <!--保存记录后返回自增的id-->
    <insert id="saveAndGetId" parameterType="java.util.Map" keyProperty="id" keyColumn="id" useGeneratedKeys="true">
        insert into xry_message (msg_type,course_type,obj_id,user_id,status,publish_date,info,created)
        values (#{msgType},#{courseType},#{objId},#{userId},#{status},#{publishDate},#{info},#{created})
        <selectKey resultType="java.lang.Long" keyProperty="id" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>
    </insert>
    <!--查询出当前保存的记录并发消息到客户端-->
    <select id="seleMessageById" parameterType="java.lang.Long" resultType="java.util.Map">
        select a.*,b.title as courseTitle, b.id as courseId, c.nickname,c.id as userId
          from  xry_message a
          left join xry_course b on  a.obj_id=b.id
          left join xry_user c on a.user_id=c.id where a.id = #{messageId}
    </select>
    <!--首页右上角消息数量查询->课程消息-->
    <select id="countCourseMessageByUserId" parameterType="java.util.Map" resultType="java.lang.Integer">
        select count(*) from xry_message xm left join xry_user_applicant xua on xm.obj_id = xua.obj_id where xm.msg_type = 1
        <if test="params.userId != null and params.userId != ''">
            and xua.user_id = #{params.userId}
        </if>
        and xua.obj_type = 0 and xua.obj_status = 0 and xm.read_status = 0
    </select>
    <!-- 首页右上角消息数量查询->讲师消息 -->
    <select id="countTeacherMessageByUserId" parameterType="java.util.Map" resultType="java.lang.Integer">
        select count(*) from xry_message xm left join xry_user_attention xua on xm.obj_id = xua.obj_id where xm.msg_type = 1
        <if test="params.userId != null and params.userId != ''">
            and xua.user_id = #{params.userId}
        </if>
        and xua.obj_type = 0 and xua.obj_status = 0 and xm.read_status = 0
    </select>
    <!-- 首页右上角消息数量查询->平台消息 -->
    <select id="countSystemMessage" resultType="java.lang.Integer">
        select count(*) from xry_message where msg_type = 3 and read_status = 0
    </select>
    <!-- 查询用户课程消息列表，包括已读和未读 -->
    <select id="listCourseMessageByUserId" parameterType="java.util.Map" resultType="java.util.Map">
        select a.*,b.title as courseTitle, b.id as courseId from xry_message a left join xry_course b on a.obj_id = b.id
        left join xry_user_applicant c on a.obj_id = c.obj_id where c.user_id = #{params.userId} and a.msg_type = 1 and c.obj_type = 0
        and c.obj_status = 0 order by a.read_status asc
    </select>
    <!-- 查询用户讲师消息列表，包括已读和未读 -->
    <select id="listTeacherMessageByUserId" parameterType="java.util.Map" resultType="java.util.Map">
        select a.*,b.real_name as realName, b.id as teacherId, d.avatar as headImg from xry_message a
            left join xry_teacher b on a.obj_id = b.id
            left join xry_user_attention c on a.user_id = c.obj_id
            left join xry_user d on d.id = b.user_id
            where c.user_id = #{params.userId} and a.msg_type = 2 and c.obj_type = 0
            and c.obj_status = 0 order by a.read_status asc
    </select>
    <!-- 查询平台消息列表 -->
    <select id="listSystemMessage" resultType="java.util.Map">
        select * from xry_message where msg_type = 3 order by read_status asc
    </select>
    
</mapper>