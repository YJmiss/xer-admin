<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.oservice.admin.modules.sys.dao.XryUserApplicantDao">

    <!--app端根据用户查询用户加入学习的课程列表-->
    <select id="appPageListCourseByUserId" parameterType="java.util.Map" resultType="java.util.Map">
        select a.*,b.title, ifnull(b.app_status,0) as 'app_status' ,b.image from xry_user_applicant a left join xry_course b on a.obj_id=b.id
          where a.obj_type = 0 and a.obj_status = 0
        <if test="params.userId != null and params.userId != ''">
            and a.user_id = #{params.userId}
        </if>
        <if test="params.flag == 2">
            and date_sub(curdate(),interval 7 day) <![CDATA[<=]]> date(a.create_time)
        </if>
        <if test="params.flag == 3">
            and date_format(a.create_time, '%Y%m' ) = date_format(curdate() , '%Y%m' )
        </if>
        <if test="params.pageSize != null and params.pageSize != ''">
            limit ${params.pageNo},${params.pageSize}
        </if>
    </select>
    <!--app端用户删除已经加入学习的课程-->
    <delete id="appDelCourseById" parameterType="java.util.Map">
        delete from xry_user_applicant where id = #{params.id}
    </delete>
    <!--根据课程id查询出报名学习该课程的所有用户-->
    <select id="listUserIdByCourseId" parameterType="java.lang.Long" resultType="com.oservice.admin.modules.sys.entity.XryUserApplicantEntity">
      select * from xry_user_applicant where obj_id = #{courseId} and obj_type = 0 and obj_status = 0
    </select>
    <!--查询出消息发送的用户id-->
    <select id="listUserIdByMsgId" parameterType="java.lang.Long" resultType="java.util.Map">
      select xua.* from xry_user_applicant xua left join xry_message xm on xua.obj_id = xm.obj_id
      where xm.id = #{msgId} and xua.obj_type = 0 and xua.obj_status = 0
    </select>
    <!--查询课程的报名人数列表-->
    <select id="countApplicantByCourseId" parameterType="java.lang.Long" resultType="com.oservice.admin.modules.sys.entity.XryUserApplicantEntity">
      select * from  xry_user_applicant where obj_id = #{courseId} and obj_type = 0 and obj_status = 0
    </select>
    <!--根据用户id和课程id查询该用户是否报名了该课程-->
    <select id="isApplicantByUserIdAndCourseId" parameterType="java.util.Map" resultType="com.oservice.admin.modules.sys.entity.XryUserApplicantEntity">
      select * from  xry_user_applicant where obj_id = #{params.courseId} and user_id = #{params.userId} and obj_type = 0 and obj_status = 0
    </select>
    <!--清除最近学习课程-->
    <update id="removeUserCourseByUserId" parameterType="java.lang.String">
      update xry_user_applicant set obj_status = 1 where user_id = #{userId} and date_sub(curdate(),interval 7 day) <![CDATA[<=]]> date(create_time)
    </update>
    <!--app保存用户课程学习进度-->
    <update id="addCourseStudyProgress" parameterType="java.util.Map">
      update xry_user_applicant set study_progress = #{params.studyProgress} where obj_id = #{params.courseId} and user_id = #{params.userId}
    </update>

</mapper>