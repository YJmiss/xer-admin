<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.oservice.admin.modules.sys.dao.XryCourseDao">

    <!--查询返回的数据总数-->
    <select id="countTotal" parameterType="java.util.Map" resultType="java.lang.Long">
        select  count(*) from xry_course where 1=1
        <if test="params.title != null and params.title != ''">
            and title like #{params.title}
        </if>
        <if test="params.cid != null and params.cid != ''">
            and cid = #{params.cid}
        </if>
        <if test="params.tid != null and params.tid != ''">
            and tid = #{params.tid}
        </if>
    </select>
    <!--自定义分页查询-->
    <select id="pageList" parameterType="java.util.Map" resultType="java.util.Map">
        select a.*,b.name as catName,c.nickname
                from xry_course a left join xry_course_cat b on  a.cid=b.id left join xry_user c on a.tid=c.id  where 1=1
        <if test="params.title != null and params.title != ''">
            and a.title like #{params.title}
        </if>
        <if test="params.cid != null and params.cid != ''">
            and a.cid = #{params.cid}
        </if>
        <if test="params.tid != null and params.tid != ''">
            and a.tid = #{params.tid}
        </if>
        <if test="params.limit != null and params.limit != ''">
            limit 0,${params.limit}
        </if>
    </select>
    <!--查询课程审核列表-->
    <select id="examineList" parameterType="java.util.Map" resultType="java.util.Map">
        select a.*,b.name as catName,c.nickname
            from xry_course a
            left join xry_course_cat b on  a.cid=b.id
            left join xry_user c on a.tid=c.id
            where a.status = 1 or a.status = 2
        <if test="params.cid != null and params.cid !=''">
            and a.cid = #{params.cid}
        </if>
        <if test="params.courseId != null and params.courseId !=''">
            and a.id = #{params.courseId}
        </if>
        <if test="params.examineStatus != null and params.examineStatus !=''">
            and a.status = #{params.examineStatus}
        </if>
        <if test="params.limit != null">
            limit 0,${params.limit}
        </if>
    </select>
    <!-- 查询课程树 -->
    <select id="treeCourse" resultType="com.oservice.admin.modules.sys.entity.XryCourseEntity">
      select * from xry_course
    </select>
    <!-- 查询课程目录 -->
    <select id="queryCourseCatalogByCourseId" resultType="com.oservice.admin.modules.sys.entity.XryCourseCatalogEntity">
        select * from xry_course_catalog where courseid = #{id}
    </select>
    <!-- 查询课描述 -->
    <select id="queryCourseDescById" resultType="com.oservice.admin.modules.sys.entity.XryCourseDescEntity">
        select * from xry_course_desc where course_id = #{id}
    </select>
    <!--课程上下架-->
    <update id="updateCourseStatus" parameterType="java.util.Map">
      update xry_course set status = #{flag} where id in
        <foreach collection="ids" item="id"  open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>
    <!-- 修改课程的状态（课程审核） -->
    <update id="recordExamineInfo" parameterType="java.util.Map">
        update xry_course set status = #{params.status} where id = #{params.id}
    </update>
    <!-- 获取索引数据 -->
    <select id="findAllItems" resultType="com.oservice.admin.common.solr.SearcherItem">
     SELECT
        a.id,
        a.title,
        a.price,
        a.image,
        a.cid,
        c.nickname,
        d.course_desc,
        b.name AS category_name
        FROM
            xry_course a,
            xry_course_cat b,
            xry_user c,
            xry_course_desc d
        WHERE
        a.id = d.course_id and a.cid = b.id and a.tid = c.id and a.status = 6;
    </select>
    <!-- 通过id获取索引数据 -->
    <select id="findItemsById" resultType="com.oservice.admin.common.solr.SearcherItem">
     SELECT
        a.id,
        a.title,
        a.price,
        a.image,
        a.cid,
        c.nickname,
        d.course_desc,
        b.name AS category_name
        FROM
            xry_course a,
            xry_course_cat b,
            xry_user c,
            xry_course_desc d
        WHERE
        a.id = d.course_id and a.cid = b.id and a.tid = c.id and a.id = #{id};
    </select>
    <!--推荐课程、取消推荐课程-->
    <update id="updateCourseRecommend" parameterType="java.util.Map">
        update xry_course set recommend = ${flag} where id in
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>
    <!--查询用户已经选择喜好的课程-->
    <select id="listRecommendCourseCatByUserId" parameterType="java.util.Map" resultType="com.oservice.admin.modules.sys.entity.XryRecommendEntity">
      select * from xry_recommend where user_id = #{userId}
    </select>
    <!--用户喜好添加-->
    <insert id="appInsertRecommend" parameterType="java.util.Map">
        insert xry_recommend(user_id, cat_id, course_id, course_title, created) values(#{userId}, #{courseCatId}, #{courseId}, #{courseTitle}, #{created});
    </insert>
    <!--用户喜好修改-->
    <update id="appUpdateRecommend" parameterType="java.util.Map">
      update xry_recommend set cat_id = #{courseCatId}, course_id = #{courseId},course_title = #{courseTitle} where user_id = #{userId}
    </update>

</mapper>