<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.oservice.admin.modules.sys.dao.XryCourseDao">

    <!--查询返回的数据总数-->
    <select id="countTotal" parameterType="java.util.Map" resultType="java.lang.Long">
        select count(*) from xry_course a left join xry_course_cat b on a.cid=b.id left join xry_teacher c on a.tid=c.id
        where 1=1
        <if test="params.title != null and params.title != ''">
            and a.title like #{params.title}
        </if>
        <if test="params.cid != null and params.cid != ''">
            and a.cid = #{params.cid}
        </if>
        <if test="params.tid != null and params.tid != ''">
            and a.tid = #{params.tid}
        </if>
        <if test="params.status != null and params.status != ''">
            and a.status = #{params.status}
        </if>
    </select>
    <!--自定义分页查询-->
    <select id="pageList" parameterType="java.util.Map" resultType="java.util.Map">
        select a.*,b.name as catName,c.real_name as realName
        from xry_course a left join xry_course_cat b on a.cid=b.id left join xry_teacher c on a.tid=c.id where 1=1
        <if test="params.title != null and params.title != ''">
            and a.title like #{params.title}
        </if>
        <if test="params.cid != null and params.cid != ''">
            and a.cid = #{params.cid}
        </if>
        <if test="params.tid != null and params.tid != ''">
            and a.tid = #{params.tid}
        </if>
        <if test="params.status != null and params.status != ''">
            and a.status = #{params.status}
        </if>
        <if test="params.pageSize != null and params.pageSize != ''">
            limit ${params.pageNo},${params.pageSize}
        </if>
    </select>
    <!--查询返回的数据总数-->
    <select id="examineCountTotal" parameterType="java.util.Map" resultType="java.lang.Long">
        select count(*) from xry_course a
        left join xry_course_cat b on a.cid=b.id left join xry_teacher c on a.tid=c.id
        where a.status = 1 or a.status = 2
        <if test="params.cid != null and params.cid !=''">
            and a.cid = #{params.cid}
        </if>
        <if test="params.courseId != null and params.courseId !=''">
            and a.id = #{params.courseId}
        </if>
        <if test="params.examineStatus != null and params.examineStatus !=''">
            and a.status = #{params.examineStatus}
        </if>
    </select>
    <!--查询课程审核列表-->
    <select id="examineList" parameterType="java.util.Map" resultType="java.util.Map">
        select a.*,b.name as catName,c.real_name as realName from xry_course a
        left join xry_course_cat b on a.cid=b.id left join xry_teacher c on a.tid=c.id
        where a.status = 1 or a.status = 2
        <if test="params.cid != null and params.cid !=''">
            and a.cid = #{params.cid}
        </if>
        <if test="params.courseId != null and params.courseId !=''">
            and a.id = #{params.courseId}
        </if>
        <if test="params.examineStatus != null and params.examineStatus !=''">
            and a.status = #{params.examineStatus}
        </if>
        <if test="params.limit != null">
            limit ${params.pageNo},${params.pageSize}
        </if>
    </select>
    <!-- 查询课程树 -->
    <select id="treeCourse" resultType="com.oservice.admin.modules.sys.entity.XryCourseEntity">
      select * from xry_course
    </select>
    <!-- 查询课程目录 -->
    <select id="queryCourseCatalogByCourseId" resultType="com.oservice.admin.modules.sys.entity.XryCourseCatalogEntity">
        select * from xry_course_catalog where courseid = #{id}
    </select>
    <!-- 查询课描述 -->
    <select id="queryCourseDescById" resultType="com.oservice.admin.modules.sys.entity.XryCourseDescEntity">
        select * from xry_course_desc where course_id = #{id}
    </select>
    <!--课程上下架-->
    <update id="updateCourseStatus" parameterType="java.util.Map">
        update xry_course set status = #{flag} where id in
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>
    <!-- 修改课程的状态（课程审核） -->
    <update id="recordExamineInfo" parameterType="java.util.Map">
        update xry_course set status = #{params.status} where id = #{params.id}
    </update>
    <!-- 获取索引数据 -->
    <select id="findAllItems" resultType="com.oservice.admin.common.solr.SearcherItem">
     SELECT
        a.id, a.title, a.price, a.image, a.cid, c.real_name,
        d.course_desc, b.name AS category_name ,a.applicant_count
        FROM
            xry_course a,
            xry_course_cat b,
            xry_teacher c,
            xry_course_desc d
        WHERE
        a.id = d.course_id and a.cid = b.id and a.tid = c.id and a.status = 4;
    </select>
    <!-- 通过id获取索引数据 -->
    <select id="findItemsById" resultType="com.oservice.admin.common.solr.SearcherItem">
     SELECT
        a.id, a.title, a.price, a.image, a.cid, c.real_name,
        d.course_desc, b.name AS category_name, a.applicant_count
        FROM
            xry_course a,
            xry_course_cat b,
            xry_teacher c,
            xry_course_desc d
        WHERE
        a.id = d.course_id and a.cid = b.id and a.tid = c.id and a.id = #{id};
    </select>
    <!--推荐课程、取消推荐课程-->
    <update id="updateCourseRecommend" parameterType="java.util.Map">
        update xry_course set recommend = ${flag} where id in
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>
    <!--查询用户已经选择喜好的课程-->
    <select id="listRecommendCourseCatByUserId" parameterType="java.util.Map"
            resultType="com.oservice.admin.modules.sys.entity.XryRecommendEntity">
      select * from xry_recommend where user_id = #{userId}
    </select>
    <!--用户喜好添加-->
    <insert id="appInsertRecommend" parameterType="java.util.Map">
        insert into xry_recommend(user_id, cat_id, created) values(#{userId,jdbcType = VARCHAR}, #{catArr,jdbcType = VARCHAR}, #{created,jdbcType = DATE});
    </insert>
    <!--用户喜好修改-->
    <update id="appUpdateRecommend" parameterType="java.util.Map">
      update xry_recommend set cat_id = #{catArr} where user_id = #{userId,jdbcType = VARCHAR}
    </update>
    <!--获取好评好课-->
    <select id="getGoodCourse" resultType="com.oservice.admin.modules.sys.entity.XryGoodCourseEntity">
    select a.id, a.score ,b.title,b.image,b.price from
    (select obj_id as 'id', AVG(star_level)as 'score',type,status from xry_comment group by obj_id HAVING type=0 and status=1) a
    ,xry_course b
    where a.score>8.5 and b.id=a.id
    </select>
    <!--根据课程id查询学习人数-->
    <select id="countStudentByCourseId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        select count(*) from xry_user_applicant where obj_id = #{courseId} and obj_type = 0 and obj_status = 0
    </select>
    <!--根据课程id查询评价人数-->
    <select id="countCommentByCourseId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        select count(*) from xry_comment where obj_id = #{courseId} and type = 0
    </select>
    <!--根据课程id查询好评度-->
    <select id="countGoodPraiseByCourseId" parameterType="java.lang.Long" resultType="java.lang.Double">
        select ifnull(avg(star_level),0) as 'score' from xry_comment where obj_id =#{courseId} and type = 0 and status = 1
    </select>
    <!--查询该讲师的好评度-->
    <select id="countGoodPraiseByTeacherId" parameterType="java.lang.String" resultType="java.lang.Double">
        select ifnull(avg(star_level),0) as 'score' from xry_comment where obj_id =#{teacherId} and type = 1 and status = 1
    </select>
    <!--该讲师的课程数-->
    <select id="countCourseByTeacherId" parameterType="java.lang.String" resultType="java.lang.Integer">
        select count(*) from xry_course where tid = #{teacherId} and status = 4
    </select>
    <!--该讲师的学生数-->
    <select id="countStudentByTeacherId" parameterType="java.lang.String" resultType="java.lang.Integer">
        select count(*) from xry_user_applicant where obj_id in (select id from xry_course where tid = #{teacherId}) and obj_type = 0 and obj_status = 0
    </select>
    <!--该机构的课程数-->
    <select id="countCourseByOrgId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        select count(*) from xry_course where tid in (select id from xry_teacher where org_id = #{orgId} and status = 3)
    </select>
    <!--该机构的学生数-->
    <select id="countStudentByOrgId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        select count(*) from xry_user_applicant where obj_id in (select id from xry_course where tid in (select id from xry_teacher where org_id = #{orgId} and status = 3)) and obj_type = 0 and obj_status = 0
    </select>
    <!--查询出该类目下管理员设置推荐的课程-->
    <select id="listCourseCatBySubCatId" parameterType="java.lang.Long" resultType="java.util.Map">
      select * from xry_course where cid = #{courseCatId} and recommend = 1 and status = 4 limit 0,10
    </select>
    <!--查询推荐列表，不足10条的随机课程列表-->
    <select id="listCourseCatBySubCatIdAndCount" parameterType="java.util.Map" resultType="java.util.Map">
      select * from xry_course where cid = #{params.courseCatId} and recommend = 0 and status = 4 limit 0,${params.courseCount}
    </select>
    <!--查询课程章节根据课程类目id-->
    <select id="countCatalogByCourseCatId" parameterType="java.lang.Long" resultType="java.lang.Integer">
      select count(*) from xry_course_catalog where courseid in (select id from xry_course where cid = #{courseCatId} and status = 4)
    </select>
    <!--查询学习人数根据课程类目id-->
    <select id="countStudentByCourseCatId" parameterType="java.lang.Long" resultType="java.lang.Integer">
      select count(*) from xry_user_applicant where obj_id in (select id from xry_course where cid = #{courseCatId} and status = 4) and obj_type = 0 and obj_status = 0
    </select>
    <!--根据课程id查询评价信息-->
    <select id="listCourseCommentByCourseId" parameterType="java.util.Map" resultType="java.util.Map">
      select a.*, b.nickname,b.phone,b.avatar from xry_comment a LEFT JOIN xry_user b on a.user_id = b.id
      WHERE a.obj_id = #{params.courseId} and a.status = 1 and a.type = 0
      order by a.created desc limit ${params.pageNo},${params.pageSize}
    </select>
    <!--查询课程"目录"-->
    <select id="listCourseCatalogByCourseId" parameterType="java.lang.Long" resultType="java.util.Map">
      select * from xry_course_catalog where courseid = #{courseId}
    </select>
    <!--根据目录id查询视频-->
    <select id="listVideoByCourseCatalogId" parameterType="java.lang.Long" resultType="java.util.Map">
      select * from xry_video where catalog_id = #{catalogId} and status = 3
    </select>
    <!--app端课程中心接口-->
    <select id="appListCourseCenter" parameterType="java.util.Map" resultType="java.util.Map">
        select a.* ,ifnull(xry.star_level,0) as 'starLevel' from xry_course a
        left join xry_course_cat b on a.cid = b.id
        left join xry_comment xry on a.id = xry.obj_id
        where a.status = 4 and b.flag = 0
        <if test="params.catId != 0">
            and b.id = #{params.catId}
        </if>

        <if test="params.type != null and params.type != ''">

        </if>
        <!-- 用户输入价格查询，此时priceTag为空 -->
        <if test="params.priceTag == null and params.priceTag == ''">
            and a.property = 1 and a.price between #{params.customPriceStart} and #{params.customPriceEnd}
        </if>
        <!-- 第一次进入页面查询所有的记录 -->
        <if test="params.priceTag == 0">
            and 1 = 1
        </if>
        <if test="params.priceTag != 0">
            <!-- 价格免费 -->
            <if test="params.priceTag == 1">
                and a.property = 2
            </if>
            <!-- 有价格区间 -->
            <if test="params.priceTag != 1">
                and a.property = 1 and a.price between #{params.priceTagStart} and #{params.priceTagEnd}
            </if>
        </if>
        <!-- 综合排序：人气、好评-->
        <if test="params.sort == 1">
            order by starLevel desc,a.applicant_count desc,a.price asc
        </if>
        <!-- 好评率排序 -->
        <if test="params.sort == 2">
            order by starLevel desc
        </if>
        <!-- 人气排序 -->
        <if test="params.sort == 3">
            order by a.applicant_count desc
        </if>
        <!-- 价格升序 -->
        <if test="params.sort == 4">
            order by a.price asc
        </if>
        <!-- 价格降序 -->
        <if test="params.sort == 5">
            order by a.price desc
        </if>
        <if test="params.pageSize != null and params.pageSize != ''">
            limit #{params.pageNo},#{params.pageSize}
        </if>
    </select>
    <!--根据课程id查询课程章节-->
    <select id="countCatalogByCourseId" parameterType="java.lang.Long" resultType="java.lang.Integer">
      select count(*) from xry_course_catalog where courseid = #{courseId}
    </select>
    <select id="selectCourseAndDescById" parameterType="java.util.Map" resultType="java.util.Map">
      select xc.*, xcd.course_desc from xry_course xc left join xry_course_desc xcd on xcd.course_id = xc.id where xc.id = #{courseId}
    </select>
    <select id="countCourseByCatId" parameterType="java.lang.Long" resultType="java.lang.Integer">
      select count(*) from xry_course where cid = #{catId}
    </select>
    <insert id="insertCourse" parameterType="com.oservice.admin.modules.sys.entity.XryCourseEntity">
        insert into xry_course (id,title,image,cid,tid,property,status,price,created,updated) values
        (#{id},#{title},#{image},#{cid},#{tid},#{property},#{status},#{price},#{created},#{updated})
    </insert>
    <select id="getFeedback" resultType="double" parameterType="java.lang.Long">
        select a.score from
        (select obj_id, AVG(star_level)as 'score',type,status from xry_comment group by obj_id HAVING type=0 and status=1 and obj_id=#{courseId}) a;
    </select>
    <!--查询最近浏览课程列表-->
    <select id="listCourseByUserIdAndCourseId" parameterType="java.util.Map" resultType="java.util.Map">
        select a.*,b.title, ifnull(b.app_status,0) as 'app_status' ,b.image from xry_user_applicant a left join xry_course b on a.obj_id=b.id
          where a.obj_type = 0 and a.obj_status = 0  and  b.id in
        <foreach collection="params.ids" item="id" open="(" separator="," close=")">
          #{id}    
        </foreach>
        <if test="params.userId != null and params.userId != ''">
            and a.user_id = #{params.userId}
        </if>
        <if test="params.pageSize != null and params.pageSize != ''">
            limit ${params.pageNo},${params.pageSize}
        </if>
    </select>

</mapper>